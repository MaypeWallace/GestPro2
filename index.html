<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ProjetoPRO - Gerenciamento de Projetos</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script>
tailwind.config = {
darkMode: 'class',
theme: {
extend: {
colors: {
primary: {
50: '#f0e7ff',
100: '#e1d0ff',
200: '#c3a0ff',
300: '#a571ff',
400: '#8741ff',
500: '#5D5CDE',
600: '#4c46c2',
700: '#3c35a6',
800: '#2c2589',
900: '#1c146d'
}
}
}
}
}

// Check for dark mode preference
if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
document.documentElement.classList.add('dark');
}
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
if (event.matches) {
document.documentElement.classList.add('dark');
} else {
document.documentElement.classList.remove('dark');
}
});
</script>
<style>
.drag-item {
cursor: grab;
transition: transform 0.2s, box-shadow 0.2s;
}
.drag-item:active {
cursor: grabbing;
transform: scale(1.02);
box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
}
.drop-zone {
transition: background-color 0.2s;
}
.drop-zone.drag-over {
background-color: rgba(93, 92, 222, 0.1);
}
.task-move-animation {
transition: all 0.3s ease;
}
/* Custom scrollbar */
::-webkit-scrollbar {
width: 6px;
height: 6px;
}
::-webkit-scrollbar-track {
background: transparent;
}
::-webkit-scrollbar-thumb {
background: #CBD5E1;
border-radius: 3px;
}
.dark ::-webkit-scrollbar-thumb {
background: #475569;
}
/* Toast notification */
.toast {
animation: slideIn 0.3s, fadeOut 0.5s 2.5s forwards;
max-width: 350px;
}
@keyframes slideIn {
from { transform: translateY(-100%); opacity: 0; }
to { transform: translateY(0); opacity: 1; }
}
@keyframes fadeOut {
from { opacity: 1; }
to { opacity: 0; visibility: hidden; }
}
/* Calendar styles */
.calendar-grid {
display: flex;
flex-direction: column;
}
.calendar-day {
aspect-ratio: 1;
display: flex;
flex-direction: column;
border-radius: 0.25rem;
overflow: hidden;
cursor: pointer;
position: relative;
transition: all 0.2s ease;
}
.calendar-day.today {
border: 2px solid;
}
.calendar-day.selected {
background-color: rgba(93, 92, 222, 0.15);
box-shadow: 0 0 0 2px rgba(93, 92, 222, 0.5);
z-index: 4;
}
.calendar-day.has-events {
background-color: rgba(93, 92, 222, 0.05);
}
.calendar-day.has-events .event-indicator {
position: absolute;
bottom: 4px;
left: 50%;
transform: translateX(-50%);
display: flex;
gap: 2px;
}
.calendar-day.has-events .event-indicator .dot {
height: 4px;
width: 4px;
border-radius: 50%;
}
.calendar-day .event-preview {
position: absolute;
bottom: 100%;
left: 50%;
transform: translateX(-50%);
background-color: white;
border: 1px solid #e5e7eb;
border-radius: 0.25rem;
padding: 0.5rem;
width: 150px;
box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
z-index: 10;
display: none;
}
.dark .calendar-day .event-preview {
background-color: #374151;
border-color: #4b5563;
}
.calendar-day:hover .event-preview {
display: block;
}
.calendar-day:hover {
background-color: rgba(0, 0, 0, 0.05);
transform: scale(1.05);
z-index: 5;
}
.dark .calendar-day:hover {
background-color: rgba(255, 255, 255, 0.05);
}
.calendar-day.other-month {
opacity: 0.4;
}
.day-events {
max-height: 100%;
overflow: hidden;
}
.calendar-day .day-events .event-badge {
margin-top: 2px;
padding: 1px 3px;
border-radius: 2px;
font-size: 0.6rem;
white-space: nowrap;
overflow: hidden;
text-overflow: ellipsis;
opacity: 0.8;
}

/* Timeline lanes */
.timeline-lane {
position: relative;
height: 60px;
margin-bottom: 5px;
border-bottom: 1px dashed rgba(200, 200, 200, 0.3);
}
.timeline-item {
transition: all 0.2s ease;
}
.timeline-item .timeline-card {
transform: scale(0.85);
opacity: 0.9;
transition: all 0.2s ease;
max-width: 250px;
}
.timeline-item:hover .timeline-card {
transform: scale(1);
opacity: 1;
z-index: 10;
}
.timeline-item .timeline-card-full-content {
display: none;
max-height: 0;
overflow: hidden;
transition: max-height 0.3s ease;
}
.timeline-item.expanded .timeline-card-full-content {
display: block;
max-height: 200px;
}
.timeline-item .timeline-compact-view {
display: block;
}
.timeline-item.expanded .timeline-compact-view {
display: none;
}
.timeline-item-wrapper {
position: absolute;
}
/* Override to prevent overlapping */
.timeline-lane-item {
margin-top: 10px;
position: relative;
transition: all 0.2s ease;
}
.timeline-lane-item:nth-child(even) {
margin-top: 30px;
}
.timeline-lane-item:nth-child(3n) {
margin-top: 50px;
}

.calendar-event-item {
cursor: pointer;
transition: all 0.2s ease;
}
.calendar-event-item:hover {
transform: translateY(-2px);
box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}
</style>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen flex flex-col">
<!-- Toast notifications container -->
<div id="toastContainer" class="fixed top-4 right-4 z-50 flex flex-col gap-2"></div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
<div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl text-center">
<div class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary-500 mb-4"></div>
<h2 class="text-xl font-semibold">Carregando dados...</h2>
<p class="text-gray-500 dark:text-gray-400 mt-2">Por favor, aguarde enquanto carregamos seu projeto.</p>
</div>
</div>

<!-- Header/Navigation -->
<header class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 shadow-sm sticky top-0 z-10">
<div class="container mx-auto px-4 py-3 flex justify-between items-center">
<div class="flex items-center space-x-2">
<i class="fas fa-project-diagram text-primary-500 text-2xl"></i>
<h1 class="text-xl font-bold">ProjetoPRO</h1>
</div>
<div class="flex items-center space-x-3">
<button id="importBtn" class="text-sm px-3 py-1.5 rounded-md bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600">
<i class="fas fa-file-import mr-1"></i> Importar
</button>
<button id="exportBtn" class="text-sm px-3 py-1.5 rounded-md bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600">
<i class="fas fa-file-export mr-1"></i> Exportar
</button>
<div class="relative">
<button id="userMenuBtn" class="flex items-center focus:outline-none">
<div class="w-8 h-8 rounded-full bg-primary-500 flex items-center justify-center text-white">
<i class="fas fa-user"></i>
</div>
</button>
<div id="userMenu" class="absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-md shadow-lg py-1 hidden">
<a href="#" id="settingsBtn" class="block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700">
<i class="fas fa-cog mr-2"></i> Configurações
</a>
<a href="#" id="helpBtn" class="block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700">
<i class="fas fa-question-circle mr-2"></i> Ajuda
</a>
</div>
</div>
</div>
</div>
</header>

<!-- Main Content -->
<div class="flex-1 flex">
<!-- Sidebar -->
<aside class="w-16 md:w-64 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 flex-shrink-0">
<div class="h-full flex flex-col">
<nav class="flex-1 py-4 px-2">
<ul class="space-y-1">
<li>
<a href="#dashboard" class="nav-link flex items-center p-2 rounded-md text-primary-500 bg-primary-50 dark:bg-primary-900/30">
<i class="fas fa-home w-6 text-center md:mr-2"></i>
<span class="hidden md:block">Dashboard</span>
</a>
</li>
<li>
<a href="#projects" class="nav-link flex items-center p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">
<i class="fas fa-folder w-6 text-center md:mr-2"></i>
<span class="hidden md:block">Projetos</span>
</a>
</li>
<li>
<a href="#tasks" class="nav-link flex items-center p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">
<i class="fas fa-tasks w-6 text-center md:mr-2"></i>
<span class="hidden md:block">Tarefas</span>
</a>
</li>
<li>
<a href="#kanban" class="nav-link flex items-center p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">
<i class="fas fa-columns w-6 text-center md:mr-2"></i>
<span class="hidden md:block">Kanban</span>
</a>
</li>
<li>
<a href="#timeline" class="nav-link flex items-center p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">
<i class="fas fa-calendar-alt w-6 text-center md:mr-2"></i>
<span class="hidden md:block">Cronograma</span>
</a>
</li>
<li>
<a href="#logs" class="nav-link flex items-center p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">
<i class="fas fa-history w-6 text-center md:mr-2"></i>
<span class="hidden md:block">Registros</span>
</a>
</li>
<li>
<a href="#ideas" class="nav-link flex items-center p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">
<i class="fas fa-lightbulb w-6 text-center md:mr-2"></i>
<span class="hidden md:block">Ideias</span>
</a>
</li>
</ul>
</nav>
<div class="p-4 border-t border-gray-200 dark:border-gray-700 hidden md:block">
<div class="text-xs text-gray-500 dark:text-gray-400">
Armazenamento
<div class="mt-1 h-2 w-full bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
<div id="storageIndicator" class="h-full bg-primary-500" style="width: 0%"></div>
</div>
<div class="mt-1 flex justify-between text-xs">
<span id="storageUsed">0 KB</span>
<span>Sem limite</span>
</div>
</div>
</div>
</div>
</aside>

<!-- Main Content Area -->
<main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-50 dark:bg-gray-900 p-4">
<!-- Page content will be loaded here -->
<div id="pageContent">
<!-- Dashboard View -->
<div id="dashboard-view" class="view-content space-y-6">
<div class="flex flex-col md:flex-row justify-between items-start md:items-center">
<h2 class="text-2xl font-bold mb-2 md:mb-0">Dashboard</h2>
<div class="flex space-x-2">
<button id="newProjectBtn" class="text-sm bg-primary-500 hover:bg-primary-600 text-white px-4 py-2 rounded-md shadow-sm">
<i class="fas fa-plus mr-1"></i> Novo Projeto
</button>
</div>
</div>

<!-- Stats Cards -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
<div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 border border-gray-200 dark:border-gray-700">
<div class="flex items-center">
<div class="flex-shrink-0 bg-blue-100 dark:bg-blue-900/30 p-3 rounded-md">
<i class="fas fa-folder text-blue-500 dark:text-blue-400"></i>
</div>
<div class="ml-4">
<p class="text-sm font-medium text-gray-500 dark:text-gray-400">Projetos Ativos</p>
<h3 id="activeProjectsCount" class="text-2xl font-bold">0</h3>
</div>
</div>
</div>

<div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 border border-gray-200 dark:border-gray-700">
<div class="flex items-center">
<div class="flex-shrink-0 bg-green-100 dark:bg-green-900/30 p-3 rounded-md">
<i class="fas fa-check-circle text-green-500 dark:text-green-400"></i>
</div>
<div class="ml-4">
<p class="text-sm font-medium text-gray-500 dark:text-gray-400">Tarefas Concluídas</p>
<h3 id="completedTasksCount" class="text-2xl font-bold">0</h3>
</div>
</div>
</div>

<div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 border border-gray-200 dark:border-gray-700">
<div class="flex items-center">
<div class="flex-shrink-0 bg-yellow-100 dark:bg-yellow-900/30 p-3 rounded-md">
<i class="fas fa-spinner text-yellow-500 dark:text-yellow-400"></i>
</div>
<div class="ml-4">
<p class="text-sm font-medium text-gray-500 dark:text-gray-400">Tarefas em Progresso</p>
<h3 id="inProgressTasksCount" class="text-2xl font-bold">0</h3>
</div>
</div>
</div>

<div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 border border-gray-200 dark:border-gray-700">
<div class="flex items-center">
<div class="flex-shrink-0 bg-pink-100 dark:bg-pink-900/30 p-3 rounded-md">
<i class="fas fa-lightbulb text-pink-500 dark:text-pink-400"></i>
</div>
<div class="ml-4">
<p class="text-sm font-medium text-gray-500 dark:text-gray-400">Ideias Registradas</p>
<h3 id="ideasCount" class="text-2xl font-bold">0</h3>
</div>
</div>
</div>
</div>

<!-- Recent Projects -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 border border-gray-200 dark:border-gray-700">
<div class="flex justify-between items-center mb-4">
<h3 class="text-lg font-semibold">Projetos Recentes</h3>
<a href="#projects" class="text-primary-500 hover:text-primary-700 text-sm">Ver todos</a>
</div>
<div class="overflow-x-auto">
<table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
<thead class="bg-gray-50 dark:bg-gray-800">
<tr>
<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Projeto</th>
<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Progresso</th>
<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Status</th>
<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Prazo</th>
</tr>
</thead>
<tbody id="recentProjectsList" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
<tr class="text-gray-500 dark:text-gray-400 text-sm">
<td class="px-6 py-4" colspan="4">Nenhum projeto encontrado. Crie um novo projeto para começar.</td>
</tr>
</tbody>
</table>
</div>
</div>

<!-- Recent Activities -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 border border-gray-200 dark:border-gray-700">
<div class="flex justify-between items-center mb-4">
<h3 class="text-lg font-semibold">Atividades Recentes</h3>
<a href="#logs" class="text-primary-500 hover:text-primary-700 text-sm">Ver todas</a>
</div>
<div class="space-y-4">
<div id="recentActivitiesList">
<p class="text-gray-500 dark:text-gray-400 text-sm">Nenhuma atividade registrada.</p>
</div>
</div>
</div>
</div>

<!-- Timeline View -->
<div id="timeline-view" class="view-content hidden space-y-6">
<div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
<h2 class="text-2xl font-bold mb-4 md:mb-0">Cronograma</h2>
<div class="space-y-2 md:space-y-0 md:flex md:items-center md:space-x-4">
<div>
<label for="timelineProjectFilter" class="block text-sm font-medium mb-1">Filtrar por projeto:</label>
<select id="timelineProjectFilter" class="w-full px-2 py-1.5 text-sm border rounded-md dark:bg-gray-700 dark:border-gray-600">
<option value="all">Todos os projetos</option>
</select>
</div>
<div>
<label for="timelineViewType" class="block text-sm font-medium mb-1">Tipo de visualização:</label>
<select id="timelineViewType" class="w-full px-2 py-1.5 text-sm border rounded-md dark:bg-gray-700 dark:border-gray-600">
<option value="timeline">Linha do tempo</option>
<option value="calendar">Calendário</option>
</select>
</div>
</div>
</div>

<!-- Timeline Container -->
<div id="timelineContent" class="space-y-6">
<!-- Timeline View -->
<div id="timelineView" class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 border border-gray-200 dark:border-gray-700">
<div id="timelineContainer" class="min-h-[400px]">
<div class="h-full flex items-center justify-center">
<div class="text-center">
<i class="fas fa-calendar-alt text-4xl text-gray-400 mb-2"></i>
<h3 class="text-lg font-medium mb-2">Carregando cronograma</h3>
<p class="text-gray-500 dark:text-gray-400">Aguarde enquanto carregamos os eventos.</p>
</div>
</div>
</div>
</div>

<!-- Calendar View (hidden by default) -->
<div id="calendarView" class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 border border-gray-200 dark:border-gray-700 hidden">
<!-- Calendar Controls -->
<div class="flex justify-between items-center mb-4">
<h3 class="text-lg font-semibold">Calendário</h3>
<div class="flex items-center space-x-1">
<button id="prevMonthBtn" class="p-1 rounded hover:bg-gray-100 dark:hover:bg-gray-700">
<i class="fas fa-chevron-left"></i>
</button>
<div id="currentMonthDisplay" class="text-sm font-medium px-2">Mês Atual</div>
<button id="nextMonthBtn" class="p-1 rounded hover:bg-gray-100 dark:hover:bg-gray-700">
<i class="fas fa-chevron-right"></i>
</button>
<button id="todayBtn" class="ml-2 text-xs px-2 py-1 bg-primary-500 text-white rounded">Hoje</button>
</div>
</div>

<!-- Calendar Grid -->
<div class="grid grid-cols-7 gap-1">
<div class="text-center text-xs text-gray-500 dark:text-gray-400 p-1">Dom</div>
<div class="text-center text-xs text-gray-500 dark:text-gray-400 p-1">Seg</div>
<div class="text-center text-xs text-gray-500 dark:text-gray-400 p-1">Ter</div>
<div class="text-center text-xs text-gray-500 dark:text-gray-400 p-1">Qua</div>
<div class="text-center text-xs text-gray-500 dark:text-gray-400 p-1">Qui</div>
<div class="text-center text-xs text-gray-500 dark:text-gray-400 p-1">Sex</div>
<div class="text-center text-xs text-gray-500 dark:text-gray-400 p-1">Sáb</div>
</div>
<div id="calendarGrid" class="grid grid-cols-7 gap-1 mt-1">
<!-- Calendar cells will be inserted here -->
</div>
</div>

<!-- Day Events -->
<div id="dayEventsContainer" class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 border border-gray-200 dark:border-gray-700 hidden">
<div class="flex justify-between items-center mb-4">
<h3 id="dayEventsTitle" class="text-lg font-semibold">Eventos do Dia</h3>
<button id="closeDayEvents" class="p-1 rounded hover:bg-gray-100 dark:hover:bg-gray-700">
<i class="fas fa-times"></i>
</button>
</div>
<div id="dayEventsList" class="space-y-3">
<!-- Day events will be inserted here -->
</div>
</div>
</div>
</div>

<!-- Kanban View -->
<div id="kanban-view" class="view-content hidden space-y-6">
<div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
<h2 class="text-2xl font-bold mb-4 md:mb-0">Kanban</h2>
<div class="space-y-2 md:space-y-0 md:flex md:space-x-4">
<div>
<label for="kanbanProjectFilter" class="block text-sm font-medium mb-1">Filtrar por projeto:</label>
<select id="kanbanProjectFilter" class="w-full md:w-48 px-2 py-1.5 text-sm border rounded-md dark:bg-gray-700 dark:border-gray-600">
<option value="all">Todos os projetos</option>
</select>
</div>
<button id="newTaskBtn" class="mt-4 md:mt-6 text-sm bg-primary-500 hover:bg-primary-600 text-white px-4 py-2 rounded-md shadow-sm">
<i class="fas fa-plus mr-1"></i> Nova Tarefa
</button>
</div>
</div>

<div class="grid grid-cols-1 md:grid-cols-3 gap-6">
<!-- To Do Column -->
<div class="space-y-4">
<div class="bg-white dark:bg-gray-800 rounded-lg p-3 border border-gray-200 dark:border-gray-700 sticky top-16">
<h3 class="font-semibold flex items-center">
<i class="fas fa-clipboard-list text-gray-400 mr-2"></i>
A Fazer
<span id="todoCount" class="ml-2 px-2 py-0.5 text-xs bg-gray-100 dark:bg-gray-700 rounded-full">0</span>
</h3>
</div>
<div id="todoLane" class="min-h-[200px] drop-zone">
<div class="h-full flex items-center justify-center text-gray-400">
<p>Nenhuma tarefa a fazer</p>
</div>
</div>
</div>

<!-- In Progress Column -->
<div class="space-y-4">
<div class="bg-white dark:bg-gray-800 rounded-lg p-3 border border-gray-200 dark:border-gray-700 sticky top-16">
<h3 class="font-semibold flex items-center">
<i class="fas fa-spinner text-yellow-500 mr-2"></i>
Em Progresso
<span id="inProgressCount" class="ml-2 px-2 py-0.5 text-xs bg-gray-100 dark:bg-gray-700 rounded-full">0</span>
</h3>
</div>
<div id="inProgressLane" class="min-h-[200px] drop-zone">
<div class="h-full flex items-center justify-center text-gray-400">
<p>Nenhuma tarefa em progresso</p>
</div>
</div>
</div>

<!-- Completed Column -->
<div class="space-y-4">
<div class="bg-white dark:bg-gray-800 rounded-lg p-3 border border-gray-200 dark:border-gray-700 sticky top-16">
<h3 class="font-semibold flex items-center">
<i class="fas fa-check-circle text-green-500 mr-2"></i>
Concluído
<span id="completedCount" class="ml-2 px-2 py-0.5 text-xs bg-gray-100 dark:bg-gray-700 rounded-full">0</span>
</h3>
</div>
<div id="completedLane" class="min-h-[200px] drop-zone">
<div class="h-full flex items-center justify-center text-gray-400">
<p>Nenhuma tarefa concluída</p>
</div>
</div>
</div>
</div>
</div>

</div>
</main>
</div>

<!-- Modals -->
<!-- New Project Modal -->
<div id="newProjectModal" class="fixed inset-0 z-50 overflow-y-auto hidden">
<div class="flex items-center justify-center min-h-screen px-4">
<div class="fixed inset-0 bg-black bg-opacity-50 transition-opacity" id="newProjectModalBackdrop"></div>
<div class="bg-white dark:bg-gray-800 rounded-lg overflow-hidden shadow-xl transform transition-all max-w-lg w-full">
<div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
<h3 class="text-lg font-semibold">Novo Projeto</h3>
</div>
<form id="newProjectForm" class="p-6">
<div class="space-y-4">
<div>
<label for="projectName" class="block text-sm font-medium mb-1">Nome do Projeto (O quê?)</label>
<input type="text" id="projectName" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base dark:bg-gray-700" required>
</div>
<div>
<label for="projectDescription" class="block text-sm font-medium mb-1">Descrição</label>
<textarea id="projectDescription" rows="3" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base dark:bg-gray-700"></textarea>
</div>

<!-- 5W2H Fields -->
<div>
<label for="projectWhy" class="block text-sm font-medium mb-1">Por quê? (Why)</label>
<textarea id="projectWhy" rows="2" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base dark:bg-gray-700" placeholder="Objetivo e justificativa do projeto"></textarea>
</div>
<div>
<label for="projectWhere" class="block text-sm font-medium mb-1">Onde? (Where)</label>
<input type="text" id="projectWhere" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base dark:bg-gray-700" placeholder="Local de execução">
</div>
<div>
<label for="projectWho" class="block text-sm font-medium mb-1">Quem? (Who)</label>
<input type="text" id="projectWho" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base dark:bg-gray-700" placeholder="Responsáveis pelo projeto">
</div>
<div>
<label for="projectHow" class="block text-sm font-medium mb-1">Como? (How)</label>
<textarea id="projectHow" rows="2" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base dark:bg-gray-700" placeholder="Método e processos utilizados"></textarea>
</div>
<div>
<label for="projectHowMuch" class="block text-sm font-medium mb-1">Quanto custa? (How much)</label>
<input type="text" id="projectHowMuch" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base dark:bg-gray-700" placeholder="Custo estimado">
</div>

<div class="grid grid-cols-2 gap-4">
<div>
<label for="projectStartDate" class="block text-sm font-medium mb-1">Data de Início (When)</label>
<input type="date" id="projectStartDate" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base dark:bg-gray-700">
</div>
<div>
<label for="projectDueDate" class="block text-sm font-medium mb-1">Data de Conclusão</label>
<input type="date" id="projectDueDate" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base dark:bg-gray-700">
</div>
</div>
<div>
<label for="projectPriority" class="block text-sm font-medium mb-1">Prioridade</label>
<select id="projectPriority" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base dark:bg-gray-700">
<option value="low">Baixa</option>
<option value="medium" selected>Média</option>
<option value="high">Alta</option>
</select>
</div>
</div>
<div class="mt-6 flex justify-end space-x-3">
<button type="button" id="cancelNewProject" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md">Cancelar</button>
<button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-primary-500 hover:bg-primary-600 rounded-md shadow-sm">Criar Projeto</button>
</div>
</form>
</div>
</div>
</div>

<!-- New Task Modal -->
<div id="newTaskModal" class="fixed inset-0 z-50 overflow-y-auto hidden">
<div class="flex items-center justify-center min-h-screen px-4">
<div class="fixed inset-0 bg-black bg-opacity-50 transition-opacity" id="newTaskModalBackdrop"></div>
<div class="bg-white dark:bg-gray-800 rounded-lg overflow-hidden shadow-xl transform transition-all max-w-lg w-full">
<div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
<h3 class="text-lg font-semibold">Nova Tarefa</h3>
</div>
<form id="newTaskForm" class="p-6">
<div class="space-y-4">
<div>
<label for="taskName" class="block text-sm font-medium mb-1">Nome da Tarefa (O quê?)</label>
<input type="text" id="taskName" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base dark:bg-gray-700" required>
</div>

<div>
<label for="taskProject" class="block text-sm font-medium mb-1">Projeto</label>
<select id="taskProject" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base dark:bg-gray-700" required>
<option value="">Selecione um projeto</option>
</select>
</div>

<div>
<label for="taskDescription" class="block text-sm font-medium mb-1">Descrição</label>
<textarea id="taskDescription" rows="2" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base dark:bg-gray-700"></textarea>
</div>

<!-- 5W2H Fields -->
<div>
<label for="taskWhy" class="block text-sm font-medium mb-1">Por quê? (Why)</label>
<textarea id="taskWhy" rows="2" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base dark:bg-gray-700" placeholder="Objetivo e justificativa da tarefa"></textarea>
</div>
<div>
<label for="taskWhere" class="block text-sm font-medium mb-1">Onde? (Where)</label>
<input type="text" id="taskWhere" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base dark:bg-gray-700" placeholder="Local de execução">
</div>
<div>
<label for="taskWho" class="block text-sm font-medium mb-1">Quem? (Who)</label>
<input type="text" id="taskWho" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base dark:bg-gray-700" placeholder="Responsáveis pela tarefa">
</div>
<div>
<label for="taskHow" class="block text-sm font-medium mb-1">Como? (How)</label>
<textarea id="taskHow" rows="2" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base dark:bg-gray-700" placeholder="Método e processos utilizados"></textarea>
</div>
<div>
<label for="taskHowMuch" class="block text-sm font-medium mb-1">Quanto custa? (How much)</label>
<input type="text" id="taskHowMuch" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base dark:bg-gray-700" placeholder="Custo estimado">
</div>

<div class="grid grid-cols-2 gap-4">
<div>
<label for="taskDueDate" class="block text-sm font-medium mb-1">Data de Conclusão (When)</label>
<input type="date" id="taskDueDate" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base dark:bg-gray-700">
</div>
<div>
<label for="taskStatus" class="block text-sm font-medium mb-1">Status</label>
<select id="taskStatus" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base dark:bg-gray-700">
<option value="todo" selected>A Fazer</option>
<option value="in_progress">Em Progresso</option>
<option value="completed">Concluída</option>
</select>
</div>
</div>

<div>
<label for="taskPriority" class="block text-sm font-medium mb-1">Prioridade</label>
<select id="taskPriority" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base dark:bg-gray-700">
<option value="low">Baixa</option>
<option value="medium" selected>Média</option>
<option value="high">Alta</option>
</select>
</div>
</div>
<div class="mt-6 flex justify-end space-x-3">
<button type="button" id="cancelNewTask" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md">Cancelar</button>
<button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-primary-500 hover:bg-primary-600 rounded-md shadow-sm">Criar Tarefa</button>
</div>
</form>
</div>
</div>
</div>

<!-- Main JavaScript -->
<script>
// Data store
const store = {
  projects: [],
  tasks: [],
  ideas: [],
  logs: [],
  lastStorageUpdate: 0
};

// Utility functions
function generateId() {
  return Date.now().toString(36) + Math.random().toString(36).substring(2);
}

function formatDate(date) {
  if (!date) return 'Não definido';
  const d = new Date(date);
  return d.toLocaleDateString('pt-BR');
}

function calculateDaysLeft(date) {
  if (!date) return null;
  
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  const dueDate = new Date(date);
  dueDate.setHours(0, 0, 0, 0);
  
  const diff = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
  
  if (diff < 0) return `Atrasado por ${Math.abs(diff)} dia(s)`;
  if (diff === 0) return 'Hoje';
  return `${diff} dia(s)`;
}

function getStatusName(status) {
  const statusMap = {
    'todo': 'A Fazer',
    'in_progress': 'Em Progresso',
    'completed': 'Concluída'
  };
  return statusMap[status] || status;
}

function getPriorityName(priority) {
  const priorityMap = {
    'low': 'Baixa',
    'medium': 'Média',
    'high': 'Alta'
  };
  return priorityMap[priority] || priority;
}

function createToast(message, type = 'success') {
  const toastContainer = document.getElementById('toastContainer');
  if (!toastContainer) return;
  
  const toast = document.createElement('div');
  toast.className = `toast p-4 rounded-md shadow-md mb-2 flex items-center`;
  
  // Style based on type
  if (type === 'success') {
    toast.classList.add('bg-green-50', 'text-green-800', 'dark:bg-green-900/30', 'dark:text-green-200');
    toast.innerHTML = `<i class="fas fa-check-circle mr-2"></i> ${message}`;
  } else if (type === 'error') {
    toast.classList.add('bg-red-50', 'text-red-800', 'dark:bg-red-900/30', 'dark:text-red-200');
    toast.innerHTML = `<i class="fas fa-exclamation-circle mr-2"></i> ${message}`;
  } else if (type === 'info') {
    toast.classList.add('bg-blue-50', 'text-blue-800', 'dark:bg-blue-900/30', 'dark:text-blue-200');
    toast.innerHTML = `<i class="fas fa-info-circle mr-2"></i> ${message}`;
  }
  
  toastContainer.appendChild(toast);
  
  // Remove toast after animation completes
  setTimeout(() => {
    toast.remove();
  }, 3000);
}

// Data persistence
function saveStore() {
  try {
    const data = JSON.stringify(store);
    localStorage.setItem('projetopro_data', data);
    
    // Update storage indicator
    const storageUsed = new Blob([data]).size;
    updateStorageIndicator(storageUsed);
    
    store.lastStorageUpdate = Date.now();
    return true;
  } catch (err) {
    console.error('Error saving data:', err);
    return false;
  }
}

function loadStore() {
  try {
    const data = localStorage.getItem('projetopro_data');
    if (data) {
      const parsed = JSON.parse(data);
      
      // Merge with store (to handle new properties in future updates)
      Object.assign(store, parsed);
      
      // Update storage indicator
      const storageUsed = new Blob([data]).size;
      updateStorageIndicator(storageUsed);
      
      return true;
    }
    return false;
  } catch (err) {
    console.error('Error loading data:', err);
    return false;
  }
}

function updateStorageIndicator(bytes) {
  const indicator = document.getElementById('storageIndicator');
  const storageText = document.getElementById('storageUsed');
  
  if (!indicator || !storageText) return;
  
  // Format bytes to KB or MB
  let sizeText;
  if (bytes < 1024) {
    sizeText = `${bytes} B`;
  } else if (bytes < 1024 * 1024) {
    sizeText = `${(bytes / 1024).toFixed(1)} KB`;
  } else {
    sizeText = `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
  }
  
  storageText.textContent = sizeText;
  
  // Calculate percentage (assume 5MB limit as example)
  const maxStorage = 5 * 1024 * 1024; // 5MB
  const percentage = Math.min(100, (bytes / maxStorage) * 100);
  indicator.style.width = `${percentage}%`;
}

// Create example data for testing/demonstration
function createExampleData() {
  // Only create example data if the store is empty
  if (store.projects.length > 0 || store.tasks.length > 0) return;
  
  // Create projects
  const project1Id = generateId();
  const project2Id = generateId();
  
  const today = new Date();
  const oneWeekAgo = new Date(today);
  oneWeekAgo.setDate(today.getDate() - 7);
  
  const oneWeekLater = new Date(today);
  oneWeekLater.setDate(today.getDate() + 7);
  
  const twoWeeksLater = new Date(today);
  twoWeeksLater.setDate(today.getDate() + 14);
  
  const threeWeeksLater = new Date(today);
  threeWeeksLater.setDate(today.getDate() + 21);
  
  // Format dates for HTML inputs (YYYY-MM-DD)
  const formatDateForInput = (date) => {
    return date.toISOString().split('T')[0];
  };
  
  // Add projects
  store.projects.push({
    id: project1Id,
    name: 'Website da Empresa',
    description: 'Desenvolvimento do novo website corporativo',
    startDate: formatDateForInput(oneWeekAgo),
    dueDate: formatDateForInput(twoWeeksLater),
    priority: 'high',
    progress: 0,
    status: 'in_progress',
    why: 'Melhorar presença online e aumentar conversões',
    where: 'Plataforma WordPress',
    who: 'Equipe de Marketing e TI',
    how: 'Desenvolvimento ágil com sprints semanais',
    howMuch: 'R$ 15.000,00',
    createdAt: new Date().toISOString()
  });
  
  store.projects.push({
    id: project2Id,
    name: 'Campanha de Marketing',
    description: 'Campanha sazonal para aumentar vendas',
    startDate: formatDateForInput(today),
    dueDate: formatDateForInput(threeWeeksLater),
    priority: 'medium',
    progress: 0,
    status: 'todo',
    why: 'Aumentar visibilidade da marca e vendas',
    where: 'Redes sociais e mídia digital',
    who: 'Departamento de Marketing',
    how: 'Campanha em redes sociais e anúncios pagos',
    howMuch: 'R$ 8.000,00',
    createdAt: new Date().toISOString()
  });
  
  // Add tasks
  store.tasks.push({
    id: generateId(),
    projectId: project1Id,
    name: 'Design da homepage',
    description: 'Criar o design da página inicial',
    dueDate: formatDateForInput(today),
    status: 'completed',
    priority: 'high',
    why: 'Estabelecer identidade visual do site',
    where: 'Figma',
    who: 'Designer UX/UI',
    how: 'Mockups e protótipos interativos',
    howMuch: 'R$ 2.000,00',
    createdAt: new Date().toISOString()
  });
  
  store.tasks.push({
    id: generateId(),
    projectId: project1Id,
    name: 'Desenvolvimento front-end',
    description: 'Implementar o HTML/CSS/JS do site',
    dueDate: formatDateForInput(oneWeekLater),
    status: 'in_progress',
    priority: 'high',
    why: 'Construir a interface do usuário',
    where: 'VS Code',
    who: 'Desenvolvedor Front-end',
    how: 'Usando HTML5, CSS3 e JavaScript',
    howMuch: 'R$ 4.000,00',
    createdAt: new Date().toISOString()
  });
  
  store.tasks.push({
    id: generateId(),
    projectId: project1Id,
    name: 'Integração com CMS',
    description: 'Conectar o front-end com o sistema de gestão de conteúdo',
    dueDate: formatDateForInput(twoWeeksLater),
    status: 'todo',
    priority: 'medium',
    why: 'Permitir atualizações de conteúdo',
    where: 'WordPress',
    who: 'Desenvolvedor Full-stack',
    how: 'Utilizando a API REST do WordPress',
    howMuch: 'R$ 3.500,00',
    createdAt: new Date().toISOString()
  });
  
  store.tasks.push({
    id: generateId(),
    projectId: project2Id,
    name: 'Planejamento da campanha',
    description: 'Definir público-alvo, canais e métricas',
    dueDate: formatDateForInput(oneWeekLater),
    status: 'todo',
    priority: 'high',
    why: 'Estabelecer direção estratégica',
    where: 'Escritório',
    who: 'Coordenador de Marketing',
    how: 'Análise de dados e reuniões de brainstorming',
    howMuch: 'R$ 1.500,00',
    createdAt: new Date().toISOString()
  });
  
  // Add logs for activities
  store.logs.push({
    id: generateId(),
    action: 'created',
    entityType: 'project',
    entityId: project1Id,
    entityName: 'Website da Empresa',
    timestamp: new Date(oneWeekAgo).toISOString(),
    details: 'Projeto criado com sucesso'
  });
  
  store.logs.push({
    id: generateId(),
    action: 'created',
    entityType: 'project',
    entityId: project2Id,
    entityName: 'Campanha de Marketing',
    timestamp: new Date().toISOString(),
    details: 'Projeto criado com sucesso'
  });
  
  store.logs.push({
    id: generateId(),
    action: 'status_change',
    entityType: 'task',
    entityId: store.tasks[0].id,
    entityName: 'Design da homepage',
    timestamp: new Date(oneWeekAgo).toISOString(),
    details: 'Status alterado de "A Fazer" para "Em Progresso"'
  });
  
  store.logs.push({
    id: generateId(),
    action: 'status_change',
    entityType: 'task',
    entityId: store.tasks[0].id,
    entityName: 'Design da homepage',
    timestamp: new Date().toISOString(),
    details: 'Status alterado de "Em Progresso" para "Concluído"'
  });
  
  // Add ideas
  store.ideas.push({
    id: generateId(),
    title: 'Blog corporativo',
    description: 'Criar um blog com conteúdo relevante para nossa indústria',
    createdAt: new Date().toISOString(),
    status: 'new'
  });
  
  store.ideas.push({
    id: generateId(),
    title: 'Aplicativo mobile',
    description: 'Desenvolver um app para clientes acessarem nossos serviços',
    createdAt: new Date(oneWeekAgo).toISOString(),
    status: 'new'
  });
  
  // Save the example data
  saveStore();
  
  // Add log entry about example data
  addLogEntry({
    action: 'system',
    entityType: 'app',
    entityName: 'ProjetoPRO',
    details: 'Dados de exemplo criados automaticamente'
  });
}

// Add log entry helper
function addLogEntry(log) {
  const newLog = {
    id: generateId(),
    timestamp: new Date().toISOString(),
    ...log
  };
  
  store.logs.unshift(newLog);
  
  // Limit logs to 100 entries
  if (store.logs.length > 100) {
    store.logs = store.logs.slice(0, 100);
  }
  
  saveStore();
  return newLog;
}

// Update dashboard statistics
function updateDashboardStats() {
  // Update counts
  document.getElementById('activeProjectsCount').textContent = store.projects.filter(p => p.status !== 'completed').length;
  document.getElementById('completedTasksCount').textContent = store.tasks.filter(t => t.status === 'completed').length;
  document.getElementById('inProgressTasksCount').textContent = store.tasks.filter(t => t.status === 'in_progress').length;
  document.getElementById('ideasCount').textContent = store.ideas.length;
  
  // Update recent projects list
  const recentProjectsList = document.getElementById('recentProjectsList');
  if (recentProjectsList) {
    if (store.projects.length === 0) {
      recentProjectsList.innerHTML = `
        <tr class="text-gray-500 dark:text-gray-400 text-sm">
          <td class="px-6 py-4" colspan="4">Nenhum projeto encontrado. Crie um novo projeto para começar.</td>
        </tr>
      `;
    } else {
      // Sort projects by created date (newest first)
      const sortedProjects = [...store.projects].sort((a, b) => {
        return new Date(b.createdAt) - new Date(a.createdAt);
      }).slice(0, 5); // Show only 5 most recent
      
      recentProjectsList.innerHTML = sortedProjects.map(project => {
        // Calculate project progress based on completed tasks
        const projectTasks = store.tasks.filter(task => task.projectId === project.id);
        const completedTasks = projectTasks.filter(task => task.status === 'completed').length;
        const progress = projectTasks.length > 0 ? Math.round((completedTasks / projectTasks.length) * 100) : 0;
        
        // Generate status badge
        let statusBadge;
        if (project.status === 'completed') {
          statusBadge = `<span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300">Concluído</span>`;
        } else if (project.status === 'in_progress') {
          statusBadge = `<span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300">Em Progresso</span>`;
        } else {
          statusBadge = `<span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300">A Iniciar</span>`;
        }
        
        // Generate days left info
        let daysLeft = '';
        if (project.dueDate) {
          const daysLeftText = calculateDaysLeft(project.dueDate);
          
          if (daysLeftText.includes('Atrasado')) {
            daysLeft = `<span class="text-red-600 dark:text-red-400">${daysLeftText}</span>`;
          } else if (daysLeftText === 'Hoje') {
            daysLeft = `<span class="text-yellow-600 dark:text-yellow-400">${daysLeftText}</span>`;
          } else {
            daysLeft = `<span>${daysLeftText}</span>`;
          }
        } else {
          daysLeft = `<span class="text-gray-500 dark:text-gray-400">Não definido</span>`;
        }
        
        return `
          <tr class="hover:bg-gray-50 dark:hover:bg-gray-800 cursor-pointer" data-project-id="${project.id}">
            <td class="px-6 py-4">
              <div class="font-medium">${project.name}</div>
              <div class="text-xs text-gray-500 dark:text-gray-400">${project.description || 'Sem descrição'}</div>
            </td>
            <td class="px-6 py-4">
              <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                <div class="bg-primary-500 h-2.5 rounded-full" style="width: ${progress}%"></div>
              </div>
              <div class="text-xs mt-1 text-right">${progress}%</div>
            </td>
            <td class="px-6 py-4">${statusBadge}</td>
            <td class="px-6 py-4">${daysLeft}</td>
          </tr>
        `;
      }).join('');
      
      // Add click event to each row
      recentProjectsList.querySelectorAll('tr[data-project-id]').forEach(row => {
        row.addEventListener('click', () => {
          const projectId = row.getAttribute('data-project-id');
          openProjectDetail(projectId);
        });
      });
    }
  }
  
  // Update recent activities
  const recentActivitiesList = document.getElementById('recentActivitiesList');
  if (recentActivitiesList) {
    if (store.logs.length === 0) {
      recentActivitiesList.innerHTML = `<p class="text-gray-500 dark:text-gray-400 text-sm">Nenhuma atividade registrada.</p>`;
    } else {
      const recentLogs = store.logs.slice(0, 5);
      
      recentActivitiesList.innerHTML = recentLogs.map(log => {
        const date = new Date(log.timestamp);
        const formattedDate = date.toLocaleDateString('pt-BR', { 
          day: '2-digit', 
          month: '2-digit', 
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
        
        let icon, iconColor;
        
        if (log.action === 'created') {
          icon = 'plus-circle';
          iconColor = 'text-green-500 dark:text-green-400';
        } else if (log.action === 'updated') {
          icon = 'edit';
          iconColor = 'text-blue-500 dark:text-blue-400';
        } else if (log.action === 'deleted') {
          icon = 'trash-alt';
          iconColor = 'text-red-500 dark:text-red-400';
        } else if (log.action === 'status_change') {
          icon = 'exchange-alt';
          iconColor = 'text-yellow-500 dark:text-yellow-400';
        } else {
          icon = 'info-circle';
          iconColor = 'text-gray-500 dark:text-gray-400';
        }
        
        return `
          <div class="flex">
            <div class="flex-shrink-0 mr-3 mt-1">
              <div class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center">
                <i class="fas fa-${icon} ${iconColor}"></i>
              </div>
            </div>
            <div>
              <p class="text-sm">${log.details}</p>
              <p class="text-xs text-gray-500 dark:text-gray-400">${formattedDate}</p>
            </div>
          </div>
        `;
      }).join('');
    }
  }
}

// Populate project selects in forms
function populateProjectSelects() {
  const projectSelects = document.querySelectorAll('#taskProject, #kanbanProjectFilter, #timelineProjectFilter');
  
  projectSelects.forEach(select => {
    // Preserve the current selection
    const currentValue = select.value;
    
    // Clear options except first one (if it's a filter)
    const firstOption = select.querySelector('option:first-child');
    select.innerHTML = '';
    
    if (firstOption && firstOption.value === 'all') {
      select.appendChild(firstOption);
    }
    
    // Add project options
    if (store.projects.length === 0) {
      const option = document.createElement('option');
      option.value = '';
      option.textContent = 'Nenhum projeto disponível';
      option.disabled = true;
      select.appendChild(option);
    } else {
      store.projects.forEach(project => {
        const option = document.createElement('option');
        option.value = project.id;
        option.textContent = project.name;
        select.appendChild(option);
      });
      
      // Restore selection if possible
      if (currentValue && select.querySelector(`option[value="${currentValue}"]`)) {
        select.value = currentValue;
      }
    }
  });
}

// Timeline functions
function calculatePosition(date, startDate, totalDays) {
  const days = Math.ceil((date - startDate) / (1000 * 60 * 60 * 24));
  return (days / totalDays) * 100;
}

function generateMonthMarkers(startDate, endDate, totalDays) {
  let markers = '';
  
  // Clone the start date to avoid modifying it
  let currentDate = new Date(startDate);
  currentDate.setDate(1); // Move to the start of the month
  
  // If we're already in the middle of a month, add a marker for the current month
  if (startDate.getDate() > 1) {
    const position = calculatePosition(currentDate, startDate, totalDays);
    const monthName = currentDate.toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' });
    
    markers += `
      <div class="absolute top-4 transform -translate-x-1/2 text-xs font-medium text-gray-600 dark:text-gray-400" style="left: ${position}%">
        ${monthName}
      </div>
    `;
  }
  
  // Move to the next month
  currentDate.setMonth(currentDate.getMonth() + 1);
  
  // Add markers for each month boundary
  while (currentDate < endDate) {
    const position = calculatePosition(currentDate, startDate, totalDays);
    const monthName = currentDate.toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' });
    
    markers += `
      <div class="absolute top-0 bottom-7 border-l border-gray-300 dark:border-gray-600" style="left: ${position}%"></div>
      <div class="absolute top-4 transform -translate-x-1/2 text-xs font-medium text-gray-600 dark:text-gray-400" style="left: ${position}%">
        ${monthName}
      </div>
    `;
    
    currentDate.setMonth(currentDate.getMonth() + 1);
  }
  
  return markers;
}

// Timeline with swimlanes
function renderTimeline(projectFilter = 'all') {
  const timelineContainer = document.getElementById('timelineContainer');
  
  if (!timelineContainer) return;
  
  // Filter tasks and projects
  let filteredProjects = [...store.projects];
  let filteredTasks = [...store.tasks];
  
  if (projectFilter !== 'all') {
    filteredProjects = filteredProjects.filter(project => project.id === projectFilter);
    filteredTasks = filteredTasks.filter(task => task.projectId === projectFilter);
  }
  
  // Combine projects and tasks into timeline items
  const timelineItems = [];
  
  // Add projects to timeline items
  filteredProjects.forEach(project => {
    if (project.startDate) {
      timelineItems.push({
        type: 'project_start',
        id: project.id,
        name: project.name,
        date: new Date(project.startDate),
        description: 'Início do projeto',
        projectId: project.id
      });
    }
    
    if (project.dueDate) {
      timelineItems.push({
        type: 'project_due',
        id: project.id,
        name: project.name,
        date: new Date(project.dueDate),
        description: 'Prazo do projeto',
        projectId: project.id
      });
    }
  });
  
  // Add tasks to timeline items
  filteredTasks.forEach(task => {
    if (task.dueDate) {
      const project = store.projects.find(p => p.id === task.projectId);
      timelineItems.push({
        type: 'task',
        id: task.id,
        name: task.name,
        projectId: task.projectId,
        projectName: project ? project.name : 'Projeto desconhecido',
        date: new Date(task.dueDate),
        status: task.status,
        priority: task.priority,
        description: 'Prazo da tarefa'
      });
    }
  });
  
  // Sort items by date
  timelineItems.sort((a, b) => a.date - b.date);
  
  if (timelineItems.length === 0) {
    timelineContainer.innerHTML = `
      <div class="h-full flex items-center justify-center">
        <div class="text-center">
          <i class="fas fa-calendar-alt text-4xl text-gray-400 mb-2"></i>
          <h3 class="text-lg font-medium mb-2">Nenhum evento no cronograma</h3>
          <p class="text-gray-500 dark:text-gray-400">Adicione projetos e tarefas com datas para visualizá-los aqui.</p>
        </div>
      </div>
    `;
    return;
  }
  
  // Calculate date range
  const earliestDate = new Date(Math.min(...timelineItems.map(item => item.date)));
  const latestDate = new Date(Math.max(...timelineItems.map(item => item.date)));
  
  // Add margin days before and after
  earliestDate.setDate(earliestDate.getDate() - 7);
  latestDate.setDate(latestDate.getDate() + 7);
  
  // Current date marker
  const today = new Date();
  
  // Calculate total days in range
  const totalDays = Math.ceil((latestDate - earliestDate) / (1000 * 60 * 60 * 24));
  
  // Group timeline items by project for swimlanes
  const projectGroups = {};
  timelineItems.forEach(item => {
    const projectId = item.projectId;
    if (!projectGroups[projectId]) {
      projectGroups[projectId] = [];
    }
    projectGroups[projectId].push(item);
  });
  
  // Generate timeline base with month markers
  let timelineHTML = `
    <div class="relative">
      <!-- Timeline axis -->
      <div class="absolute left-0 right-0 h-1 bg-gray-300 dark:bg-gray-600 top-10"></div>
      
      <!-- Today marker -->
      <div class="absolute top-7 bottom-0 border-l-2 border-primary-500 dark:border-primary-400" style="left: ${calculatePosition(today, earliestDate, totalDays)}%;">
        <div class="bg-primary-500 text-white text-xs px-1.5 py-0.5 rounded absolute -left-9 -top-7">
          Hoje
        </div>
      </div>
      
      <!-- Month markers -->
      ${generateMonthMarkers(earliestDate, latestDate, totalDays)}
      
      <!-- Project Lanes -->
      <div class="mt-16">
  `;
  
  // Generate lanes for each project
  let laneIndex = 0;
  for (const [projectId, projectItems] of Object.entries(projectGroups)) {
    const project = store.projects.find(p => p.id === projectId);
    const projectName = project ? project.name : 'Projeto desconhecido';
    
    timelineHTML += `
      <div class="timeline-lane mb-8">
        <div class="text-sm font-medium mb-2">${projectName}</div>
        <div class="relative h-16">
    `;
    
    // Group items by date to prevent overlap
    const itemsByDate = {};
    projectItems.forEach(item => {
      const dateStr = item.date.toDateString();
      if (!itemsByDate[dateStr]) {
        itemsByDate[dateStr] = [];
      }
      itemsByDate[dateStr].push(item);
    });
    
    // Render items in this lane, with staggered layout for items on the same date
    Object.entries(itemsByDate).forEach(([dateStr, dateItems], dateIndex) => {
      dateItems.forEach((item, itemIndex) => {
        const position = calculatePosition(item.date, earliestDate, totalDays);
        
        // Apply staggering for multiple items on the same date
        const verticalOffset = itemIndex * 20; // pixels to offset vertically
        
        // Determine icon, color based on item type and properties
        let icon, bgColor, textColor;
        
        if (item.type === 'project_start') {
          icon = 'play-circle';
          bgColor = 'bg-green-100 dark:bg-green-900/30';
          textColor = 'text-green-800 dark:text-green-200';
        } else if (item.type === 'project_due') {
          icon = 'flag-checkered';
          bgColor = 'bg-blue-100 dark:bg-blue-900/30';
          textColor = 'text-blue-800 dark:text-blue-200';
        } else if (item.type === 'task') {
          icon = 'tasks';
          
          // Determine colors based on priority and status
          if (item.status === 'completed') {
            bgColor = 'bg-green-100 dark:bg-green-900/30';
            textColor = 'text-green-800 dark:text-green-200';
          } else if (item.priority === 'high') {
            bgColor = 'bg-red-100 dark:bg-red-900/30';
            textColor = 'text-red-800 dark:text-red-200';
          } else if (item.priority === 'medium') {
            bgColor = 'bg-yellow-100 dark:bg-yellow-900/30';
            textColor = 'text-yellow-800 dark:text-yellow-200';
          } else {
            bgColor = 'bg-gray-100 dark:bg-gray-700';
            textColor = 'text-gray-800 dark:text-gray-200';
          }
        }
        
        // Format date
        const formattedDate = item.date.toLocaleDateString();
        
        timelineHTML += `
          <div class="timeline-lane-item absolute" style="left: ${position}%; top: ${verticalOffset}px;">
            <div class="timeline-item cursor-pointer" data-type="${item.type}" data-id="${item.id}">
              <!-- Connector line -->
              <div class="absolute left-1/2 -ml-px w-0.5 bg-gray-300 dark:bg-gray-600 h-6 -top-6"></div>
              
              <!-- Item dot -->
              <div class="absolute -top-8 left-1/2 transform -translate-x-1/2 w-4 h-4 rounded-full ${bgColor}"></div>
              
              <!-- Item content - Minimized View -->
              <div class="absolute top-0 -translate-x-1/2 w-40">
                <div class="${bgColor} ${textColor} rounded-lg p-2 shadow-sm border border-gray-200 dark:border-gray-700 timeline-card">
                  <div class="flex items-start">
                    <div class="flex-shrink-0 mt-0.5">
                      <i class="fas fa-${icon}"></i>
                    </div>
                    <div class="ml-2 flex-1">
                      <!-- Compact view (always visible) -->
                      <div class="timeline-compact-view">
                        <p class="text-xs font-medium truncate">${item.name}</p>
                        <p class="text-xs text-opacity-70">${formattedDate}</p>
                        <div class="text-xs mt-1 bg-gray-100 dark:bg-gray-700 bg-opacity-40 dark:bg-opacity-40 px-1 py-0.5 rounded text-center">
                          <small>Clique para detalhes</small>
                        </div>
                      </div>
                      
                      <!-- Full content (displayed when expanded) -->
                      <div class="timeline-card-full-content border-t border-gray-200 dark:border-gray-600 pt-2 mt-1">
                        <p class="text-xs font-medium">${item.name}</p>
                        <p class="text-xs">${item.description}</p>
                        <p class="text-xs mt-1">${formattedDate}</p>
                        ${item.type === 'task' ? `
                          <div class="text-xs mt-1 pt-1">
                            <p><b>Status:</b> ${getStatusName(item.status)}</p>
                            <p><b>Prioridade:</b> ${item.priority === 'high' ? 'Alta' : item.priority === 'medium' ? 'Média' : 'Baixa'}</p>
                          </div>
                        ` : ''}
                        <div class="mt-2 text-xs text-center bg-primary-100 dark:bg-primary-900/30 text-primary-700 dark:text-primary-300 p-1 rounded">
                          <p>Clique para abrir detalhes do projeto</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      });
    });
    
    timelineHTML += `
        </div>
      </div>
    `;
    
    laneIndex++;
  }
  
  timelineHTML += `
      </div>
    </div>
  `;
  
  timelineContainer.innerHTML = timelineHTML;
  
  // Add event listeners to timeline items
  document.querySelectorAll('.timeline-item').forEach(item => {
    // Toggle expanded view on click
    item.addEventListener('click', function(e) {
      // If it was already expanded, open the project detail
      if (this.classList.contains('expanded')) {
        // Open project detail
        const itemType = this.getAttribute('data-type');
        const itemId = this.getAttribute('data-id');
        
        const projectId = itemType === 'task' 
          ? store.tasks.find(t => t.id === itemId)?.projectId 
          : itemId;
        
        if (projectId) {
          openProjectDetail(projectId);
        }
      } else {
        // First, close all other expanded items
        document.querySelectorAll('.timeline-item.expanded').forEach(expandedItem => {
          if (expandedItem !== this) {
            expandedItem.classList.remove('expanded');
          }
        });
        
        // Then toggle this item
        this.classList.toggle('expanded');
      }
    });
  });
}

// Calendar functions
function renderCalendar(year, month, projectFilter = 'all') {
  const calendarGrid = document.getElementById('calendarGrid');
  if (!calendarGrid) return;
  
  // Update month display
  const currentMonthDisplay = document.getElementById('currentMonthDisplay');
  if (currentMonthDisplay) {
    const monthDate = new Date(year, month, 1);
    currentMonthDisplay.textContent = monthDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
  }
  
  // Clear existing content
  calendarGrid.innerHTML = '';
  
  // Get first day of month and total days
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const daysInMonth = lastDay.getDate();
  
  // Get day of week of first day (0 is Sunday, 1 is Monday, etc.)
  let firstDayOfWeek = firstDay.getDay();
  
  // Calculate days from previous month
  const prevMonthLastDay = new Date(year, month, 0).getDate();
  const prevMonthDays = firstDayOfWeek;
  
  // Calculate days from next month
  const nextMonthDays = 42 - (prevMonthDays + daysInMonth); // 42 = 6 weeks * 7 days
  
  // Get current date
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  // Filter events by project
  let filteredProjects = [...store.projects];
  let filteredTasks = [...store.tasks];
  
  if (projectFilter !== 'all') {
    filteredProjects = filteredProjects.filter(project => project.id === projectFilter);
    filteredTasks = filteredTasks.filter(task => task.projectId === projectFilter);
  }
  
  // Get events for the calendar
  const events = {};
  
  // Add project events
  filteredProjects.forEach(project => {
    if (project.startDate) {
      const startDate = new Date(project.startDate);
      const dateKey = startDate.toDateString();
      
      if (!events[dateKey]) {
        events[dateKey] = [];
      }
      
      events[dateKey].push({
        type: 'project_start',
        name: project.name,
        description: 'Início do projeto',
        color: 'green'
      });
    }
    
    if (project.dueDate) {
      const dueDate = new Date(project.dueDate);
      const dateKey = dueDate.toDateString();
      
      if (!events[dateKey]) {
        events[dateKey] = [];
      }
      
      events[dateKey].push({
        type: 'project_due',
        name: project.name,
        description: 'Prazo do projeto',
        color: 'blue'
      });
    }
  });
  
  // Add task events
  filteredTasks.forEach(task => {
    if (task.dueDate) {
      const dueDate = new Date(task.dueDate);
      const dateKey = dueDate.toDateString();
      
      if (!events[dateKey]) {
        events[dateKey] = [];
      }
      
      let color;
      if (task.status === 'completed') {
        color = 'green';
      } else if (task.priority === 'high') {
        color = 'red';
      } else if (task.priority === 'medium') {
        color = 'yellow';
      } else {
        color = 'gray';
      }
      
      events[dateKey].push({
        type: 'task',
        name: task.name,
        description: 'Prazo da tarefa',
        status: task.status,
        color
      });
    }
  });
  
  // Previous month days
  for (let i = prevMonthLastDay - prevMonthDays + 1; i <= prevMonthLastDay; i++) {
    const dayDate = new Date(year, month - 1, i);
    const dateStr = dayDate.toDateString();
    const dayEvents = events[dateStr] || [];
    
    calendarGrid.appendChild(createCalendarDay(i, dateStr, dayEvents, 'other-month'));
  }
  
  // Current month days
  for (let i = 1; i <= daysInMonth; i++) {
    const dayDate = new Date(year, month, i);
    const dateStr = dayDate.toDateString();
    const dayEvents = events[dateStr] || [];
    const isToday = dayDate.toDateString() === today.toDateString();
    
    calendarGrid.appendChild(createCalendarDay(i, dateStr, dayEvents, isToday ? 'today' : ''));
  }
  
  // Next month days
  for (let i = 1; i <= nextMonthDays; i++) {
    const dayDate = new Date(year, month + 1, i);
    const dateStr = dayDate.toDateString();
    const dayEvents = events[dateStr] || [];
    
    calendarGrid.appendChild(createCalendarDay(i, dateStr, dayEvents, 'other-month'));
  }
}

function createCalendarDay(dayNumber, dateStr, events, extraClass = '') {
  const dayElement = document.createElement('div');
  dayElement.className = `calendar-day p-1 border border-gray-200 dark:border-gray-700 ${extraClass}`;
  dayElement.setAttribute('data-date', dateStr);
  
  // Day number
  const dayNumberElement = document.createElement('div');
  dayNumberElement.className = 'text-xs font-medium mb-1';
  dayNumberElement.textContent = dayNumber;
  dayElement.appendChild(dayNumberElement);
  
  // Add events indicator if there are events
  if (events.length > 0) {
    dayElement.classList.add('has-events');
    
    // Show up to 2 event badges
    const dayEvents = document.createElement('div');
    dayEvents.className = 'day-events';
    
    const maxVisibleEvents = Math.min(2, events.length);
    
    for (let i = 0; i < maxVisibleEvents; i++) {
      const event = events[i];
      const eventBadge = document.createElement('div');
      eventBadge.className = `event-badge bg-${event.color}-100 dark:bg-${event.color}-900/30 text-${event.color}-800 dark:text-${event.color}-300`;
      eventBadge.textContent = event.name;
      dayEvents.appendChild(eventBadge);
    }
    
    // Add indicator if there are more events
    if (events.length > maxVisibleEvents) {
      const moreIndicator = document.createElement('div');
      moreIndicator.className = 'text-xs text-center mt-1';
      moreIndicator.textContent = `+${events.length - maxVisibleEvents} mais`;
      dayEvents.appendChild(moreIndicator);
    }
    
    dayElement.appendChild(dayEvents);
    
    // Add event dots indicator
    const indicatorContainer = document.createElement('div');
    indicatorContainer.className = 'event-indicator';
    
    const dotCount = Math.min(3, events.length);
    for (let i = 0; i < dotCount; i++) {
      const dot = document.createElement('div');
      dot.className = `dot bg-${events[i].color}-500 dark:bg-${events[i].color}-400`;
      indicatorContainer.appendChild(dot);
    }
    
    dayElement.appendChild(indicatorContainer);
    
    // Add event preview (visible on hover)
    const eventPreview = document.createElement('div');
    eventPreview.className = 'event-preview';
    
    if (events.length === 1) {
      const event = events[0];
      eventPreview.innerHTML = `
        <div class="text-xs font-medium">${event.name}</div>
        <div class="text-xs">${event.description}</div>
      `;
    } else {
      eventPreview.innerHTML = `
        <div class="text-xs font-medium">${events.length} eventos neste dia</div>
        <div class="text-xs">Clique para ver detalhes</div>
      `;
    }
    
    dayElement.appendChild(eventPreview);
  }
  
  // Add click event
  dayElement.addEventListener('click', () => {
    showDayEvents(dateStr);
  });
  
  return dayElement;
}

// Calendar Day Events
function showDayEvents(dateStr) {
  // First, clear any previous selections
  document.querySelectorAll('.calendar-day.selected').forEach(day => {
    day.classList.remove('selected');
  });
  
  // Select the clicked day
  const clickedDay = document.querySelector(`.calendar-day[data-date="${dateStr}"]`);
  if (clickedDay) {
    clickedDay.classList.add('selected');
  }
  
  const date = new Date(dateStr);
  const dateDisplay = date.toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
  
  // Set day events title
  const dayEventsTitle = document.getElementById('dayEventsTitle');
  if (dayEventsTitle) {
    dayEventsTitle.textContent = `Eventos de ${dateDisplay}`;
  }
  
  // Get all events for this date
  const events = [];
  const projectFilter = document.getElementById('timelineProjectFilter')?.value || 'all';
  
  // Filter projects
  let filteredProjects = [...store.projects];
  if (projectFilter !== 'all') {
    filteredProjects = filteredProjects.filter(project => project.id === projectFilter);
  }
  
  // Add project events
  filteredProjects.forEach(project => {
    if (project.startDate) {
      const startDate = new Date(project.startDate);
      if (startDate.toDateString() === date.toDateString()) {
        events.push({
          type: 'project_start',
          id: project.id,
          name: project.name,
          description: 'Início do projeto',
          color: 'green',
          project: project
        });
      }
    }
    
    if (project.dueDate) {
      const dueDate = new Date(project.dueDate);
      if (dueDate.toDateString() === date.toDateString()) {
        events.push({
          type: 'project_due',
          id: project.id,
          name: project.name,
          description: 'Prazo do projeto',
          color: 'blue',
          project: project
        });
      }
    }
  });
  
  // Filter tasks
  let filteredTasks = [...store.tasks];
  if (projectFilter !== 'all') {
    filteredTasks = filteredTasks.filter(task => task.projectId === projectFilter);
  }
  
  // Add task events
  filteredTasks.forEach(task => {
    if (task.dueDate) {
      const dueDate = new Date(task.dueDate);
      if (dueDate.toDateString() === date.toDateString()) {
        const project = store.projects.find(p => p.id === task.projectId);
        
        let color;
        if (task.status === 'completed') {
          color = 'green';
        } else if (task.priority === 'high') {
          color = 'red';
        } else if (task.priority === 'medium') {
          color = 'yellow';
        } else {
          color = 'gray';
        }
        
        events.push({
          type: 'task',
          id: task.id,
          name: task.name,
          projectId: task.projectId,
          projectName: project ? project.name : 'Projeto desconhecido',
          description: 'Prazo da tarefa',
          status: task.status,
          color,
          task: task,
          project: project
        });
      }
    }
  });
  
  // Display events
  const dayEventsList = document.getElementById('dayEventsList');
  if (dayEventsList) {
    if (events.length === 0) {
      dayEventsList.innerHTML = `<p class="text-gray-500 dark:text-gray-400">Nenhum evento neste dia.</p>`;
    } else {
      dayEventsList.innerHTML = events.map(event => {
        // Event icon based on type
        let icon;
        if (event.type === 'project_start') {
          icon = 'play-circle';
        } else if (event.type === 'project_due') {
          icon = 'flag-checkered';
        } else {
          icon = 'tasks';
        }
        
        // For tasks, show their status
        let statusBadge = '';
        if (event.type === 'task') {
          let statusClass, statusText;
          switch (event.status) {
            case 'todo':
              statusClass = 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300';
              statusText = 'A Fazer';
              break;
            case 'in_progress':
              statusClass = 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300';
              statusText = 'Em Progresso';
              break;
            case 'completed':
              statusClass = 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300';
              statusText = 'Concluída';
              break;
          }
          statusBadge = `<span class="ml-2 px-1.5 py-0.5 text-xs rounded-full ${statusClass}">${statusText}</span>`;
        }
        
        // Project link for tasks
        let projectLink = '';
        if (event.type === 'task' && event.project) {
          projectLink = `<div class="text-xs text-gray-500 dark:text-gray-400">Projeto: ${event.projectName}</div>`;
        }
        
        // Project details (5W2H)
        let projectDetails = '';
        if ((event.type === 'project_start' || event.type === 'project_due') && event.project) {
          const project = event.project;
          projectDetails = `
            <div class="mt-2 bg-gray-50 dark:bg-gray-700 p-2 rounded text-xs">
              <div class="font-medium mb-1">Detalhes do Projeto:</div>
              ${project.description ? `<div class="mb-1"><b>Descrição:</b> ${project.description}</div>` : ''}
              ${project.why ? `<div class="mb-1"><b>Por quê:</b> ${project.why}</div>` : ''}
              ${project.who ? `<div class="mb-1"><b>Quem:</b> ${project.who}</div>` : ''}
              ${project.where ? `<div class="mb-1"><b>Onde:</b> ${project.where}</div>` : ''}
              ${project.how ? `<div class="mb-1"><b>Como:</b> ${project.how}</div>` : ''}
              ${project.howMuch ? `<div><b>Quanto:</b> ${project.howMuch}</div>` : ''}
            </div>
          `;
        } else if (event.type === 'task' && event.task) {
          const task = event.task;
          projectDetails = `
            <div class="mt-2 bg-gray-50 dark:bg-gray-700 p-2 rounded text-xs">
              <div class="font-medium mb-1">Detalhes da Tarefa:</div>
              ${task.description ? `<div class="mb-1"><b>Descrição:</b> ${task.description}</div>` : ''}
              ${task.why ? `<div class="mb-1"><b>Por quê:</b> ${task.why}</div>` : ''}
              ${task.who ? `<div class="mb-1"><b>Quem:</b> ${task.who}</div>` : ''}
              ${task.where ? `<div class="mb-1"><b>Onde:</b> ${task.where}</div>` : ''}
              ${task.how ? `<div class="mb-1"><b>Como:</b> ${task.how}</div>` : ''}
              ${task.howMuch ? `<div><b>Quanto:</b> ${task.howMuch}</div>` : ''}
            </div>
          `;
        }
        
        return `
          <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-md p-3 calendar-event-item"
               data-type="${event.type}" data-id="${event.id}">
            <div class="flex items-start">
              <div class="flex-shrink-0 w-8 h-8 bg-${event.color}-100 dark:bg-${event.color}-900/30 rounded-full flex items-center justify-center">
                <i class="fas fa-${icon} text-${event.color}-500 dark:text-${event.color}-400"></i>
              </div>
              <div class="ml-3 flex-1">
                <div class="flex items-center">
                  <h4 class="font-medium">${event.name}</h4>
                  ${statusBadge}
                </div>
                <p class="text-sm text-gray-600 dark:text-gray-400">${event.description}</p>
                ${projectLink}
                ${projectDetails}
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      // Add click event to calendar events
      document.querySelectorAll('.calendar-event-item').forEach(item => {
        item.addEventListener('click', function() {
          const itemType = this.getAttribute('data-type');
          const itemId = this.getAttribute('data-id');
          
          if (itemType === 'task') {
            // Find the task and open its project
            const task = store.tasks.find(t => t.id === itemId);
            if (task) {
              openProjectDetail(task.projectId);
            }
          } else {
            // Open project directly
            openProjectDetail(itemId);
          }
        });
      });
    }
  }
  
  // Show events container
  const dayEventsContainer = document.getElementById('dayEventsContainer');
  if (dayEventsContainer) {
    dayEventsContainer.classList.remove('hidden');
  }
}

// Open project detail (placeholder for now)
function openProjectDetail(projectId) {
  const project = store.projects.find(p => p.id === projectId);
  if (!project) return;
  
  createToast(`Projeto "${project.name}" selecionado. Detalhes do projeto serão implementados em breve.`, 'info');
}

// Kanban functions
function updateKanbanBoard(projectFilter = 'all') {
  // Get lane elements
  const todoLane = document.getElementById('todoLane');
  const inProgressLane = document.getElementById('inProgressLane');
  const completedLane = document.getElementById('completedLane');
  
  if (!todoLane || !inProgressLane || !completedLane) return;
  
  // Get tasks filtered by project
  let filteredTasks = [...store.tasks];
  if (projectFilter !== 'all') {
    filteredTasks = filteredTasks.filter(task => task.projectId === projectFilter);
  }
  
  // Group tasks by status
  const todoTasks = filteredTasks.filter(task => task.status === 'todo');
  const inProgressTasks = filteredTasks.filter(task => task.status === 'in_progress');
  const completedTasks = filteredTasks.filter(task => task.status === 'completed');
  
  // Update counters
  document.getElementById('todoCount').textContent = todoTasks.length;
  document.getElementById('inProgressCount').textContent = inProgressTasks.length;
  document.getElementById('completedCount').textContent = completedTasks.length;
  
  // Generate task cards
  todoLane.innerHTML = todoTasks.length > 0 ? generateTaskCards(todoTasks) : 
    `<div class="h-full flex items-center justify-center text-gray-400">
      <p>Nenhuma tarefa a fazer</p>
    </div>`;
  
  inProgressLane.innerHTML = inProgressTasks.length > 0 ? generateTaskCards(inProgressTasks) : 
    `<div class="h-full flex items-center justify-center text-gray-400">
      <p>Nenhuma tarefa em progresso</p>
    </div>`;
  
  completedLane.innerHTML = completedTasks.length > 0 ? generateTaskCards(completedTasks) : 
    `<div class="h-full flex items-center justify-center text-gray-400">
      <p>Nenhuma tarefa concluída</p>
    </div>`;
  
  // Setup drag and drop
  setupDragAndDrop();
}

function generateTaskCards(tasks) {
  return tasks.map(task => {
    const project = store.projects.find(p => p.id === task.projectId);
    const projectName = project ? project.name : 'Projeto desconhecido';
    
    // Determine priority classes
    let priorityClass, priorityText;
    switch (task.priority) {
      case 'high':
        priorityClass = 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300';
        priorityText = 'Alta';
        break;
      case 'medium':
        priorityClass = 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300';
        priorityText = 'Média';
        break;
      case 'low':
        priorityClass = 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300';
        priorityText = 'Baixa';
        break;
    }
    
    // Format due date
    let dueDate = '';
    if (task.dueDate) {
      const daysLeft = calculateDaysLeft(task.dueDate);
      const formattedDate = formatDate(task.dueDate);
      
      if (daysLeft.includes('Atrasado')) {
        dueDate = `<div class="text-xs mt-2 text-red-600 dark:text-red-400">
          <i class="fas fa-exclamation-circle mr-1"></i> ${daysLeft} (${formattedDate})
        </div>`;
      } else if (daysLeft === 'Hoje') {
        dueDate = `<div class="text-xs mt-2 text-yellow-600 dark:text-yellow-400">
          <i class="fas fa-clock mr-1"></i> Vence ${daysLeft} (${formattedDate})
        </div>`;
      } else {
        dueDate = `<div class="text-xs mt-2 text-gray-500 dark:text-gray-400">
          <i class="far fa-calendar-alt mr-1"></i> Vence em ${daysLeft} (${formattedDate})
        </div>`;
      }
    }
    
    return `
      <div class="drag-item bg-white dark:bg-gray-800 rounded-lg shadow p-3 mb-2 border border-gray-200 dark:border-gray-700" data-task-id="${task.id}">
        <div class="flex items-start">
          <div class="flex-1">
            <h4 class="font-medium">${task.name}</h4>
            <div class="text-xs text-gray-500 dark:text-gray-400">
              <i class="fas fa-folder mr-1"></i> ${projectName}
            </div>
            ${task.description ? `<p class="text-sm mt-2 text-gray-600 dark:text-gray-400">${task.description}</p>` : ''}
            
            <div class="flex mt-3 items-center justify-between">
              <span class="px-2 py-1 text-xs rounded-full ${priorityClass}">
                ${priorityText}
              </span>
              
              <div class="task-actions">
                <button class="text-gray-400 hover:text-primary-500 dark:hover:text-primary-400" title="Editar">
                  <i class="fas fa-pencil-alt"></i>
                </button>
              </div>
            </div>
            
            ${dueDate}
          </div>
        </div>
      </div>
    `;
  }).join('');
}

function setupDragAndDrop() {
  // Get all draggable items
  const draggables = document.querySelectorAll('.drag-item');
  const dropZones = document.querySelectorAll('.drop-zone');
  
  // Add drag events to draggable items
  draggables.forEach(draggable => {
    draggable.setAttribute('draggable', 'true');
    
    draggable.addEventListener('dragstart', function(e) {
      this.classList.add('dragging');
      e.dataTransfer.setData('text/plain', this.getAttribute('data-task-id'));
    });
    
    draggable.addEventListener('dragend', function() {
      this.classList.remove('dragging');
    });
  });
  
  // Add drop events to drop zones
  dropZones.forEach(zone => {
    zone.addEventListener('dragover', function(e) {
      e.preventDefault();
      this.classList.add('drag-over');
    });
    
    zone.addEventListener('dragleave', function() {
      this.classList.remove('drag-over');
    });
    
    zone.addEventListener('drop', function(e) {
      e.preventDefault();
      this.classList.remove('drag-over');
      
      const taskId = e.dataTransfer.getData('text/plain');
      const taskElement = document.querySelector(`.drag-item[data-task-id="${taskId}"]`);
      
      if (!taskElement) return;
      
      // Determine new status based on drop zone
      let newStatus;
      
      if (this.id === 'todoLane') {
        newStatus = 'todo';
      } else if (this.id === 'inProgressLane') {
        newStatus = 'in_progress';
      } else if (this.id === 'completedLane') {
        newStatus = 'completed';
      }
      
      // Update task status
      if (newStatus) {
        updateTaskStatus(taskId, newStatus);
      }
    });
  });
}

function updateTaskStatus(taskId, newStatus) {
  const task = store.tasks.find(t => t.id === taskId);
  
  if (!task) return;
  
  const oldStatus = task.status;
  
  // If status didn't change, do nothing
  if (oldStatus === newStatus) return;
  
  // Update task status
  task.status = newStatus;
  
  // Save changes
  saveStore();
  
  // Add log entry
  addLogEntry({
    action: 'status_change',
    entityType: 'task',
    entityId: taskId,
    entityName: task.name,
    details: `Status alterado de "${getStatusName(oldStatus)}" para "${getStatusName(newStatus)}"`
  });
  
  // Update UI with animation for smoother transition
  updateKanbanBoard(document.getElementById('kanbanProjectFilter').value);
  
  // Show notification
  createToast(`Tarefa "${task.name}" movida para ${getStatusName(newStatus)}`, 'success');
}

// Navigation and views
function setupNavigation() {
  // Add click events to navigation links
  document.querySelectorAll('.nav-link').forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      
      // Get the hash without the # character
      const viewName = this.getAttribute('href').substring(1);
      
      // Hide all views
      document.querySelectorAll('.view-content').forEach(view => {
        view.classList.add('hidden');
      });
      
      // Remove active class from all nav links
      document.querySelectorAll('.nav-link').forEach(navLink => {
        navLink.classList.remove('text-primary-500', 'bg-primary-50', 'dark:bg-primary-900/30');
        navLink.classList.add('hover:bg-gray-100', 'dark:hover:bg-gray-700');
      });
      
      // Add active class to clicked link
      this.classList.add('text-primary-500', 'bg-primary-50', 'dark:bg-primary-900/30');
      this.classList.remove('hover:bg-gray-100', 'dark:hover:bg-gray-700');
      
      // Show the selected view
      const viewElement = document.getElementById(`${viewName}-view`);
      if (viewElement) {
        viewElement.classList.remove('hidden');
        
        // Call specific init function for the view
        if (viewName === 'timeline') {
          initTimelineView();
        } else if (viewName === 'kanban') {
          initKanbanView();
        }
      }
    });
  });
}

// Initialize views
function initTimelineView() {
  const timelineViewType = document.getElementById('timelineViewType');
  const timelineProjectFilter = document.getElementById('timelineProjectFilter');
  
  // Render timeline based on current selection
  const showSelectedView = () => {
    const viewType = timelineViewType.value;
    const projectFilter = timelineProjectFilter.value;
    
    // Show timeline or calendar view
    document.getElementById('timelineView').style.display = viewType === 'timeline' ? 'block' : 'none';
    document.getElementById('calendarView').style.display = viewType === 'calendar' ? 'block' : 'none';
    
    // Hide day events when switching views
    document.getElementById('dayEventsContainer').classList.add('hidden');
    
    if (viewType === 'timeline') {
      renderTimeline(projectFilter);
    } else {
      // Get current month/year or use current date
      const today = new Date();
      renderCalendar(today.getFullYear(), today.getMonth(), projectFilter);
    }
  };
  
  // Add change event to view type selector
  timelineViewType.addEventListener('change', showSelectedView);
  
  // Add change event to project filter
  timelineProjectFilter.addEventListener('change', showSelectedView);
  
  // Calendar navigation
  const prevMonthBtn = document.getElementById('prevMonthBtn');
  const nextMonthBtn = document.getElementById('nextMonthBtn');
  const todayBtn = document.getElementById('todayBtn');
  
  let currentMonth = new Date().getMonth();
  let currentYear = new Date().getFullYear();
  
  if (prevMonthBtn) {
    prevMonthBtn.addEventListener('click', () => {
      currentMonth--;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      }
      renderCalendar(currentYear, currentMonth, timelineProjectFilter.value);
    });
  }
  
  if (nextMonthBtn) {
    nextMonthBtn.addEventListener('click', () => {
      currentMonth++;
      if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      }
      renderCalendar(currentYear, currentMonth, timelineProjectFilter.value);
    });
  }
  
  if (todayBtn) {
    todayBtn.addEventListener('click', () => {
      const today = new Date();
      currentMonth = today.getMonth();
      currentYear = today.getFullYear();
      renderCalendar(currentYear, currentMonth, timelineProjectFilter.value);
    });
  }
  
  // Close day events button
  const closeDayEvents = document.getElementById('closeDayEvents');
  if (closeDayEvents) {
    closeDayEvents.addEventListener('click', () => {
      document.getElementById('dayEventsContainer').classList.add('hidden');
      
      // Remove selection from calendar days
      document.querySelectorAll('.calendar-day.selected').forEach(day => {
        day.classList.remove('selected');
      });
    });
  }
  
  // Initial render
  showSelectedView();
}

function initKanbanView() {
  const kanbanProjectFilter = document.getElementById('kanbanProjectFilter');
  
  // Update kanban when filter changes
  kanbanProjectFilter.addEventListener('change', function() {
    updateKanbanBoard(this.value);
  });
  
  // Initial render
  updateKanbanBoard(kanbanProjectFilter.value);
}

// Form handling for new projects
function setupProjectForm() {
  const newProjectBtn = document.getElementById('newProjectBtn');
  const newProjectModal = document.getElementById('newProjectModal');
  const newProjectForm = document.getElementById('newProjectForm');
  const cancelNewProject = document.getElementById('cancelNewProject');
  const newProjectModalBackdrop = document.getElementById('newProjectModalBackdrop');
  
  // Show modal when clicking the new project button
  if (newProjectBtn) {
    newProjectBtn.addEventListener('click', () => {
      if (newProjectModal) {
        newProjectModal.classList.remove('hidden');
      }
    });
  }
  
  // Hide modal when clicking cancel or backdrop
  if (cancelNewProject) {
    cancelNewProject.addEventListener('click', () => {
      if (newProjectModal) {
        newProjectModal.classList.add('hidden');
        newProjectForm.reset();
      }
    });
  }
  
  if (newProjectModalBackdrop) {
    newProjectModalBackdrop.addEventListener('click', () => {
      if (newProjectModal) {
        newProjectModal.classList.add('hidden');
        newProjectForm.reset();
      }
    });
  }
  
  // Handle form submission
  if (newProjectForm) {
    newProjectForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      // Create new project from form data
      const newProject = {
        id: generateId(),
        name: document.getElementById('projectName').value,
        description: document.getElementById('projectDescription').value,
        why: document.getElementById('projectWhy').value,
        where: document.getElementById('projectWhere').value,
        who: document.getElementById('projectWho').value,
        how: document.getElementById('projectHow').value,
        howMuch: document.getElementById('projectHowMuch').value,
        startDate: document.getElementById('projectStartDate').value,
        dueDate: document.getElementById('projectDueDate').value,
        priority: document.getElementById('projectPriority').value,
        status: 'todo',
        progress: 0,
        createdAt: new Date().toISOString()
      };
      
      // Add project to store
      store.projects.push(newProject);
      
      // Add log entry
      addLogEntry({
        action: 'created',
        entityType: 'project',
        entityId: newProject.id,
        entityName: newProject.name,
        details: 'Projeto criado com sucesso'
      });
      
      // Save store
      saveStore();
      
      // Refresh UI
      updateDashboardStats();
      populateProjectSelects();
      
      // Hide modal and reset form
      newProjectModal.classList.add('hidden');
      newProjectForm.reset();
      
      // Show success message
      createToast(`Projeto "${newProject.name}" criado com sucesso`, 'success');
    });
  }
}

// Form handling for new tasks
function setupTaskForm() {
  const newTaskBtn = document.getElementById('newTaskBtn');
  const newTaskModal = document.getElementById('newTaskModal');
  const newTaskForm = document.getElementById('newTaskForm');
  const cancelNewTask = document.getElementById('cancelNewTask');
  const newTaskModalBackdrop = document.getElementById('newTaskModalBackdrop');
  
  // Show modal when clicking the new task button
  if (newTaskBtn) {
    newTaskBtn.addEventListener('click', () => {
      if (newTaskModal) {
        // Check if there are any projects
        if (store.projects.length === 0) {
          createToast('Crie um projeto antes de adicionar tarefas', 'error');
          return;
        }
        
        newTaskModal.classList.remove('hidden');
        
        // Pre-select project if filtering by project
        const kanbanProjectFilter = document.getElementById('kanbanProjectFilter');
        const taskProject = document.getElementById('taskProject');
        
        if (kanbanProjectFilter && taskProject && kanbanProjectFilter.value !== 'all') {
          taskProject.value = kanbanProjectFilter.value;
        }
      }
    });
  }
  
  // Hide modal when clicking cancel or backdrop
  if (cancelNewTask) {
    cancelNewTask.addEventListener('click', () => {
      if (newTaskModal) {
        newTaskModal.classList.add('hidden');
        newTaskForm.reset();
      }
    });
  }
  
  if (newTaskModalBackdrop) {
    newTaskModalBackdrop.addEventListener('click', () => {
      if (newTaskModal) {
        newTaskModal.classList.add('hidden');
        newTaskForm.reset();
      }
    });
  }
  
  // Handle form submission
  if (newTaskForm) {
    newTaskForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const projectId = document.getElementById('taskProject').value;
      
      // Create new task from form data
      const newTask = {
        id: generateId(),
        projectId: projectId,
        name: document.getElementById('taskName').value,
        description: document.getElementById('taskDescription').value,
        why: document.getElementById('taskWhy').value,
        where: document.getElementById('taskWhere').value,
        who: document.getElementById('taskWho').value,
        how: document.getElementById('taskHow').value,
        howMuch: document.getElementById('taskHowMuch').value,
        dueDate: document.getElementById('taskDueDate').value,
        status: document.getElementById('taskStatus').value,
        priority: document.getElementById('taskPriority').value,
        createdAt: new Date().toISOString()
      };
      
      // Add task to store
      store.tasks.push(newTask);
      
      // Add log entry
      addLogEntry({
        action: 'created',
        entityType: 'task',
        entityId: newTask.id,
        entityName: newTask.name,
        details: `Tarefa criada para o projeto "${store.projects.find(p => p.id === projectId)?.name || 'Desconhecido'}"`
      });
      
      // Save store
      saveStore();
      
      // Refresh UI
      updateDashboardStats();
      updateKanbanBoard(document.getElementById('kanbanProjectFilter').value);
      
      // Hide modal and reset form
      newTaskModal.classList.add('hidden');
      newTaskForm.reset();
      
      // Show success message
      createToast(`Tarefa "${newTask.name}" criada com sucesso`, 'success');
    });
  }
}

// Initialize app
function initApp() {
  // Set up event listener for storage changes
  window.addEventListener('storage', (e) => {
    if (e.key === 'projetopro_data') {
      loadStore();
      updateDashboardStats();
      populateProjectSelects();
      
      createToast('Dados atualizados', 'info');
    }
  });
  
  // User menu toggle
  const userMenuBtn = document.getElementById('userMenuBtn');
  const userMenu = document.getElementById('userMenu');
  
  if (userMenuBtn && userMenu) {
    userMenuBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      userMenu.classList.toggle('hidden');
    });
    
    document.addEventListener('click', () => {
      if (!userMenu.classList.contains('hidden')) {
        userMenu.classList.add('hidden');
      }
    });
  }
  
  // Export button
  const exportBtn = document.getElementById('exportBtn');
  if (exportBtn) {
    exportBtn.addEventListener('click', () => {
      const dataStr = JSON.stringify(store, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      
      // Create a temporary anchor element
      const downloadLink = document.createElement('a');
      downloadLink.href = URL.createObjectURL(dataBlob);
      downloadLink.download = `projetopro_export_${new Date().toISOString().split('T')[0]}.json`;
      downloadLink.style.display = 'none';
      
      // Add to document, click and remove
      document.body.appendChild(downloadLink);
      downloadLink.click();
      document.body.removeChild(downloadLink);
      
      createToast('Dados exportados com sucesso', 'success');
    });
  }
  
  // Import button (just a placeholder for now)
  const importBtn = document.getElementById('importBtn');
  if (importBtn) {
    importBtn.addEventListener('click', () => {
      createToast('Funcionalidade de importação será implementada em breve', 'info');
    });
  }
  
  // Setup navigation and forms
  setupNavigation();
  setupProjectForm();
  setupTaskForm();
  
  // Load data from local storage or create example data
  const dataLoaded = loadStore();
  if (!dataLoaded) {
    createExampleData();
  }
  
  // Update UI
  updateDashboardStats();
  populateProjectSelects();
  
  // Show dashboard by default
  const dashboardLink = document.querySelector('.nav-link[href="#dashboard"]');
  if (dashboardLink) {
    dashboardLink.click();
  }
  
  // Hide loading overlay
  const loadingOverlay = document.getElementById('loadingOverlay');
  if (loadingOverlay) {
    loadingOverlay.classList.add('hidden');
  }
  
  // Show welcome message
  createToast('Bem-vindo ao ProjetoPRO!', 'success');
}

// Start the app
document.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>